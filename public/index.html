<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Catalog Viewer</title>
    <style>
      :root{
        --bg:#0b1220;
        --card:#0f1a2f;
        --muted:#93a4c7;
        --text:#e8eeff;
        --line:rgba(255,255,255,.08);
        --btn:#1d4ed8;
        --btn2:#334155;
      }
      body{
        margin:0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Hebrew", sans-serif;
        background:var(--bg);
        color:var(--text);
      }
      header{
        padding:18px 16px;
        border-bottom:1px solid var(--line);
        position:sticky;
        top:0;
        background:linear-gradient(to bottom, rgba(11,18,32,.98), rgba(11,18,32,.92));
        backdrop-filter: blur(6px);
        z-index:10;
      }
      .row{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }
      .row > *{ flex: 0 0 auto; }
      .grow{ flex: 1 1 auto; min-width:220px; }
      input{
        width:100%;
        padding:10px 12px;
        border-radius:10px;
        border:1px solid var(--line);
        background:rgba(255,255,255,.03);
        color:var(--text);
        outline:none;
      }
      button{
        padding:10px 12px;
        border-radius:10px;
        border:1px solid var(--line);
        color:var(--text);
        background:var(--btn2);
        cursor:pointer;
      }
      button.primary{ background:var(--btn); border-color:rgba(255,255,255,.12); }
      button:disabled{ opacity:.5; cursor:not-allowed; }
      main{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:14px;
        padding:14px;
      }
      @media (max-width: 980px){
        main{ grid-template-columns:1fr; }
      }
      .card{
        background:var(--card);
        border:1px solid var(--line);
        border-radius:14px;
        overflow:hidden;
        min-height:220px;
      }
      .card h2{
        margin:0;
        font-size:15px;
        padding:12px 12px;
        border-bottom:1px solid var(--line);
        color:#dbe6ff;
      }
      .status{
        margin-top:10px;
        font-size:13px;
        color:var(--muted);
      }
      .list{
        max-height:62vh;
        overflow:auto;
      }
      .item{
        padding:10px 12px;
        border-bottom:1px solid var(--line);
        cursor:pointer;
      }
      .item:hover{ background:rgba(255,255,255,.03); }
      .title{ font-size:14px; }
      .meta{ font-size:12px; color:var(--muted); margin-top:4px; }
      .mono{
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        white-space: pre-wrap;
        word-break: break-word;
        padding:12px;
        line-height:1.55;
      }
      .hint{
        padding:12px;
        color:var(--muted);
        font-size:13px;
      }
      .tabs{
        display:flex;
        gap:8px;
        padding:10px 12px;
        border-bottom:1px solid var(--line);
      }
      .tab{
        padding:8px 10px;
        border-radius:10px;
        border:1px solid var(--line);
        background:rgba(255,255,255,.03);
        cursor:pointer;
        font-size:13px;
        color:var(--text);
      }
      .tab.active{
        background:rgba(29,78,216,.25);
        border-color:rgba(29,78,216,.45);
      }
      .small{
        font-size:12px;
        color:var(--muted);
      }
      .path{
        direction:ltr;
        unicode-bidi: plaintext;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size:12px;
        color:var(--muted);
      }
    </style>
  </head>

  <body>
    <header>
      <div class="row">
        <button id="btnLoad" class="primary">טען קטלוג</button>
        <button id="btnClear">נקה</button>
        <input id="q" class="grow" type="search" placeholder="חפש לפי כותרת / מחבר..." disabled />
      </div>
      <div id="status" class="status">מוכן.</div>
      <div class="status small">
        מקור נתונים: <span id="baseLabel" class="path"></span>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>רשימת כותרים (metadata)</h2>
        <div id="listMeta" class="list">
          <div class="hint">לחץ על "טען קטלוג" כדי לטעון את הרשימה.</div>
        </div>
      </section>

      <section class="card">
        <h2>קבצים ותוכן (manifest + viewer)</h2>
        <div class="tabs">
          <button id="tabFiles" class="tab active">קבצים</button>
          <button id="tabText" class="tab">תוכן</button>
        </div>
        <div id="paneFiles" class="list">
          <div class="hint">לאחר טעינה, יוצגו כאן נתיבי קבצים מה־manifest.</div>
        </div>
        <div id="paneText" style="display:none;">
          <div id="textHeader" class="hint">
            בחר קובץ כדי להציג את התוכן כאן.
          </div>
          <div id="textBody" class="mono"></div>
        </div>
      </section>
    </main>

    <script>
      // =========================
      // SETTINGS
      // =========================
      // אם שמת metadata.json + files_manifest.json ליד index.html, שנה ל:
      // const LIB_BASE = ".";
      const LIB_BASE = "https://raw.githubusercontent.com/amram313/otzaria-library/main";

      // =========================
      // STATE
      // =========================
      const state = {
        meta: [],
        files: [],
        loaded: false,
        lastSelectedPath: ""
      };

      // =========================
      // DOM
      // =========================
      const $ = (id) => document.getElementById(id);

      const btnLoad = $("btnLoad");
      const btnClear = $("btnClear");
      const q = $("q");
      const statusEl = $("status");
      const baseLabel = $("baseLabel");

      const listMeta = $("listMeta");
      const paneFiles = $("paneFiles");
      const paneText = $("paneText");
      const textHeader = $("textHeader");
      const textBody = $("textBody");

      const tabFiles = $("tabFiles");
      const tabText = $("tabText");

      baseLabel.textContent = LIB_BASE;

      // =========================
      // HELPERS
      // =========================
      function setStatus(msg){
        statusEl.textContent = msg;
      }

      function encodePath(p){
        return (p || "")
          .split("/")
          .map(seg => encodeURIComponent(seg))
          .join("/");
      }

      async function fetchJson(url){
        const r = await fetch(url, { cache: "no-store" });
        const t = await r.text();
        if(!r.ok){
          throw new Error(`HTTP ${r.status} (${url}) :: ${t.slice(0,180)}`);
        }
        try{
          return JSON.parse(t);
        }catch(e){
          throw new Error(`JSON parse failed (${url}) :: ${t.slice(0,180)}`);
        }
      }

      function normalizeMeta(raw){
        // מצפה למערך. אם הגיע עטוף באובייקט, מנסה לחלץ.
        if(Array.isArray(raw)) return raw;
        if(raw && Array.isArray(raw.items)) return raw.items;
        if(raw && Array.isArray(raw.data)) return raw.data;
        if(raw && Array.isArray(raw.metadata)) return raw.metadata;
        return [];
      }

      function normalizeFiles(raw){
        // מנסה כמה מבנים נפוצים של manifest
        // 1) ["a/b.txt", ...]
        if(Array.isArray(raw) && raw.every(x => typeof x === "string")) return raw;

        // 2) { files: ["..."] }
        if(raw && Array.isArray(raw.files)) return raw.files.filter(x => typeof x === "string");

        // 3) { all: ["..."] } / { paths: ["..."] }
        if(raw && Array.isArray(raw.paths)) return raw.paths.filter(x => typeof x === "string");
        if(raw && Array.isArray(raw.all)) return raw.all.filter(x => typeof x === "string");

        // 4) tree-like: { name, children:[...] }  או  [{name, children}]
