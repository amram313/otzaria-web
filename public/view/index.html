<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>צפייה</title>
    <style>
      :root{
        --fs: 18px;
        --lh: 1.8;
        --pageMax: 980px;
        --pad: 18px;
        --tocW: 280px;
      }
      body{
        font-family: system-ui, Arial;
        margin: 0;
        background: #fafafa;
      }
      body.book{
        --pageMax: 760px;
        --pad: 22px;
        --lh: 1.95;
      }

      .topbar{
        position: sticky;
        top: 0;
        z-index: 20;
        background: #fafafa;
        border-bottom: 1px solid #eee;
        padding: 10px 12px;
      }
      .row{
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .spacer{ flex: 1; }

      .btn{
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }
      .btn:active{ transform: translateY(1px); }
      .pill{
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 999px;
        background: #fff;
        font-size: 12px;
        color: #444;
      }
      .select{
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #fff;
        font-size: 14px;
      }
      .meta{
        margin-top: 6px;
        font-size: 12px;
        color: #666;
        word-break: break-all;
      }

      .wrap{
        max-width: calc(var(--pageMax) + var(--tocW) + 40px);
        margin: 0 auto;
        padding: 14px 12px 22px 12px;
      }

      .layout{
        display: grid;
        grid-template-columns: var(--tocW) 1fr;
        gap: 14px;
        align-items: start;
      }

      .toc{
        position: sticky;
        top: 86px;
        max-height: calc(100vh - 110px);
        overflow: auto;
        background: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 10px;
      }
      .toc h4{
        margin: 0 0 8px 0;
        font-size: 13px;
        color: #444;
      }
      .toc a{
        display: block;
        padding: 6px 8px;
        border-radius: 10px;
        text-decoration: none;
        color: #222;
        font-size: 13px;
      }
      .toc a:hover{
        background: #f3f3f3;
      }
      .toc .small{
        color: #666;
        font-size: 12px;
      }

      .card{
        background: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: var(--pad);
        max-width: var(--pageMax);
      }

      .loading{
        font-size: 14px;
        color: #666;
      }

      .content{
        font-size: var(--fs);
        line-height: var(--lh);
      }
      .content h1{ font-size: 1.55em; margin: 0 0 10px 0; }
      .content h2{ font-size: 1.25em; margin: 18px 0 8px 0; }
      .content h3{ font-size: 1.08em; margin: 14px 0 6px 0; }
      .content p { margin: 10px 0; }
      .content h2, .content h3{ scroll-margin-top: 110px; }

      .pre{
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: calc(var(--fs) - 3px);
        line-height: 1.65;
        direction: rtl;
      }

      iframe{
        width: 100%;
        height: 80vh;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        background: #fff;
      }

      .err{
        color: #a00;
        font-size: 14px;
        white-space: pre-wrap;
        direction: ltr;
        text-align: left;
      }

      @media (max-width: 980px){
        .layout{ grid-template-columns: 1fr; }
        .toc{ position: static; max-height: none; }
        .card{ max-width: none; }
      }
    </style>
  </head>

  <body>
    <div class="topbar">
      <div class="row">
        <button class="btn" onclick="history.back()">חזור</button>
        <button class="btn" id="btnRaw">פתח מקור (RAW)</button>

        <span class="pill" id="fontLabel">גופן: —</span>
        <button class="btn" id="btnMinus" title="הקטן גופן">−</button>
        <button class="btn" id="btnPlus" title="הגדל גופן">+</button>

        <button class="btn" id="btnBook" title="מצב עמוד ספר">עמוד ספר: כבוי</button>

        <span class="spacer"></span>

        <button class="btn" id="btnPrev" style="display:none;">◀ פסוק קודם</button>
        <button class="btn" id="btnNext" style="display:none;">פסוק הבא ▶</button>

        <select class="select" id="chapterSel" style="display:none;"></select>
        <select class="select" id="verseSel" style="display:none;"></select>
        <button class="btn" id="btnTop" style="display:none;">למעלה</button>
      </div>

      <div class="meta" id="meta"></div>
    </div>

    <div class="wrap">
      <div class="layout">
        <aside class="toc" id="toc" style="display:none;">
          <h4>תוכן עניינים</h4>
          <div class="small" id="tocHint"></div>
          <div id="tocList"></div>
        </aside>

        <main>
          <div class="card" id="card">
            <div class="loading" id="loading">טוען…</div>

            <div class="content" id="content" style="display:none;"></div>
            <pre class="pre" id="pre" style="display:none;"></pre>
            <div class="err" id="err" style="display:none;"></div>
            <iframe id="pdf" style="display:none;"></iframe>
          </div>
        </main>
      </div>
    </div>

    <script>
      function encodePath(path){
        return String(path).split("/").filter(Boolean).map(encodeURIComponent).join("/")
      }
      function getParam(name){
        const u = new URL(location.href)
        return u.searchParams.get(name) || ""
      }
      function isPdf(path){
        return /\.pdf$/i.test(path || "")
      }
      function looksLikeHtml(text){
        const t = String(text || "")
        return /<\/?(h1|h2|h3|p|b|strong|div|span)\b/i.test(t)
      }

      function sanitizeHtml(html){
        const doc = new DOMParser().parseFromString(String(html || ""), "text/html")
        doc.querySelectorAll("script, style, iframe, object, embed, link").forEach(n => n.remove())

        doc.querySelectorAll("*").forEach(el => {
          for (const attr of Array.from(el.attributes)){
            const name = String(attr.name || "").toLowerCase()
            const val = String(attr.value || "")
            if (name.startsWith("on")) el.removeAttribute(attr.name)
            if (name === "href" && /^\s*javascript:/i.test(val)) el.removeAttribute(attr.name)
          }
          if (el.tagName === "A"){
            el.setAttribute("target","_blank")
            el.setAttribute("rel","noreferrer noopener")
          }
        })

        return doc.body.innerHTML
      }

      function clamp(n,a,b){ return Math.max(a, Math.min(b,n)) }

      function loadPrefs(){
        const fs = Number(localStorage.getItem("view_fs") || "18")
        const book = localStorage.getItem("view_book") === "1"
        return { fs: clamp(Number.isFinite(fs) ? fs : 18, 12, 34), book }
      }
      function savePrefs(p){
        localStorage.setItem("view_fs", String(p.fs))
        localStorage.setItem("view_book", p.book ? "1" : "0")
      }
      function applyPrefs(p){
        document.documentElement.style.setProperty("--fs", p.fs + "px")
        document.getElementById("fontLabel").textContent = "גופן: " + p.fs
        document.body.classList.toggle("book", !!p.book)
        document.getElementById("btnBook").textContent = "עמוד ספר: " + (p.book ? "פעיל" : "כבוי")
      }

      function slug(text){
        const t = String(text || "").trim()
        return t.replace(/\s+/g,"-").replace(/[^\u0590-\u05FFa-zA-Z0-9\-]/g,"").slice(0,80) || ("sec-" + Math.random().toString(16).slice(2))
      }

      function textOf(el){ return String(el && el.textContent ? el.textContent : "").trim() }

      function isChapter(t){ return /^פרק\s+/i.test(t) }
      function isVerse(t){ return /^פסוק\s+/i.test(t) }

      function buildNav(){
        const content = document.getElementById("content")
        const nodes = Array.from(content.querySelectorAll("h2, h3"))

        const chapters = []
        const verses = []
        let currentChapterIndex = -1

        for (let i = 0; i < nodes.length; i++){
          const n = nodes[i]
          const t = textOf(n)

          if (n.tagName === "H2" && isChapter(t)){
            if (!n.id) n.id = "ch-" + chapters.length + "-" + slug(t)
            currentChapterIndex = chapters.length
            chapters.push({ id: n.id, label: t, verses: [] })
          }

          if (n.tagName === "H3" && isVerse(t)){
            if (!n.id) n.id = "v-" + verses.length + "-" + slug(t)
            const v = { id: n.id, label: t, chapterIndex: currentChapterIndex }
            verses.push(v)
            if (currentChapterIndex >= 0) chapters[currentChapterIndex].verses.push(v)
          }
        }

        const hasNav = chapters.length > 0 || verses.length > 0
        if (!hasNav) return { chapters: [], verses: [] }

        // Selects
        const chapterSel = document.getElementById("chapterSel")
        const verseSel = document.getElementById("verseSel")
        const btnTop = document.getElementById("btnTop")
        const btnPrev = document.getElementById("btnPrev")
        const btnNext = document.getElementById("btnNext")

        chapterSel.style.display = "inline-block"
        verseSel.style.display = "inline-block"
        btnTop.style.display = "inline-block"
        btnPrev.style.display = "inline-block"
        btnNext.style.display = "inline-block"

        chapterSel.innerHTML = ""
        const opt0 = document.createElement("option")
        opt0.value = ""
        opt0.textContent = "בחר פרק…"
        chapterSel.appendChild(opt0)

        chapters.forEach((ch, idx) => {
          const o = document.createElement("option")
          o.value = String(idx)
          o.textContent = ch.label
          chapterSel.appendChild(o)
        })

        function fillVerses(chIdx){
          verseSel.innerHTML = ""
          const o0 = document.createElement("option")
          o0.value = ""
          o0.textContent = "בחר פסוק…"
          verseSel.appendChild(o0)

          const ch = chapters[chIdx]
          if (!ch || !ch.verses || ch.verses.length === 0) return

          ch.verses.forEach((v, idx) => {
            const o = document.createElement("option")
            o.value = String(idx)
            o.textContent = v.label
            verseSel.appendChild(o)
          })
        }

        function scrollToId(id){
          const el = document.getElementById(id)
          if (!el) return
          el.scrollIntoView({ behavior: "smooth", block: "start" })
        }

        chapterSel.onchange = () => {
          const idx = Number(chapterSel.value)
          if (!Number.isFinite(idx)) return
          fillVerses(idx)
          scrollToId(chapters[idx].id)
        }

        verseSel.onchange = () => {
          const chIdx = Number(chapterSel.value)
          const vIdx = Number(verseSel.value)
          if (!Number.isFinite(chIdx) || !Number.isFinite(vIdx)) return
          const ch = chapters[chIdx]
          if (!ch || !ch.verses || !ch.verses[vIdx]) return
          scrollToId(ch.verses[vIdx].id)
        }

        btnTop.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" })

        // Prev/Next verse (לפי כל הפסוקים שנמצאו)
        let currentVerseIndex = -1
        function setCurrentVerseByScroll(){
          // משוער: מחפש פסוק קרוב לראש הדף
          const topY = window.scrollY + 130
          let best = -1
          for (let i = 0; i < verses.length; i++){
            const el = document.getElementById(verses[i].id)
            if (!el) continue
            const y = el.getBoundingClientRect().top + window.scrollY
            if (y <= topY) best = i
            else break
          }
          currentVerseIndex = best
        }

        btnPrev.onclick = () => {
          if (verses.length === 0) return
          if (currentVerseIndex <= 0) scrollToId(verses[0].id)
          else scrollToId(verses[currentVerseIndex - 1].id)
        }
        btnNext.onclick = () => {
          if (verses.length === 0) return
          if (currentVerseIndex < 0) scrollToId(verses[0].id)
          else if (currentVerseIndex + 1 >= verses.length) scrollToId(verses[verses.length - 1].id)
          else scrollToId(verses[currentVerseIndex + 1].id)
        }

        window.addEventListener("scroll", () => setCurrentVerseByScroll(), { passive: true })
        setCurrentVerseByScroll()

        // Sidebar TOC
        const toc = document.getElementById("toc")
        const tocList = document.getElementById("tocList")
        const tocHint = document.getElementById("tocHint")
        toc.style.display = "block"
        tocList.innerHTML = ""

        tocHint.textContent =
          "נמצאו " + chapters.length + " פרקים, " + verses.length + " פסוקים."

        chapters.forEach((ch) => {
          const a = document.createElement("a")
          a.href = "#" + ch.id
          a.textContent = ch.label
          a.onclick = (e) => { e.preventDefault(); scrollToId(ch.id) }
          tocList.appendChild(a)

          // פסוקים תחת פרק (מקטין עומס: עד 40)
          const max = 40
          const count = ch.verses ? ch.verses.length : 0
          const show = Math.min(count, max)

          for (let i = 0; i < show; i++){
            const v = ch.verses[i]
            const av = document.createElement("a")
            av.href = "#" + v.id
            av.textContent = "  " + v.label
            av.style.paddingRight = "18px"
            av.style.color = "#444"
            av.onclick = (e) => { e.preventDefault(); scrollToId(v.id) }
            tocList.appendChild(av)
          }

          if (count > max){
            const more = document.createElement("div")
            more.className = "small"
            more.style.padding = "6px 8px"
            more.textContent = "… ועוד " + (count - max) + " פסוקים"
            tocList.appendChild(more)
          }
        })

        return { chapters, verses }
      }

      async function main(){
        const prefs = loadPrefs()
        applyPrefs(prefs)

        document.getElementById("btnMinus").onclick = () => {
          const p = loadPrefs()
          p.fs = clamp(p.fs - 1, 12, 34)
          savePrefs(p)
          applyPrefs(p)
        }
        document.getElementById("btnPlus").onclick = () => {
          const p = loadPrefs()
          p.fs = clamp(p.fs + 1, 12, 34)
          savePrefs(p)
          applyPrefs(p)
        }
        document.getElementById("btnBook").onclick = () => {
          const p = loadPrefs()
          p.book = !p.book
          savePrefs(p)
          applyPrefs(p)
        }

        const path = getParam("path")
        const meta = document.getElementById("meta")
        const loading = document.getElementById("loading")
        const content = document.getElementById("content")
        const pre = document.getElementById("pre")
        const err = document.getElementById("err")
        const pdf = document.getElementById("pdf")
        const btnRaw = document.getElementById("btnRaw")

        if (!path){
          loading.style.display = "none"
          err.style.display = "block"
          err.textContent = "Missing ?path="
          return
        }

        meta.textContent = "path: " + path

        btnRaw.onclick = () => {
          const u = "/lib/" + encodePath(path)
          window.open(u, "_blank", "noopener,noreferrer")
        }

        if (isPdf(path)){
          loading.style.display = "none"
          pdf.style.display = "block"
          pdf.src = "/lib/" + encodePath(path)
          return
        }

        const url = "/lib/" + encodePath(path)
        const r = await fetch(url, { cache: "no-store" })
        if (!r.ok){
          loading.style.display = "none"
          err.style.display = "block"
          err.textContent = "Fetch failed: " + r.status + "\n" + url
          return
        }

        const text = await r.text()

        loading.style.display = "none"

        if (looksLikeHtml(text)){
          const safe = sanitizeHtml(text)
          if (safe && safe.trim().length > 10){
            content.style.display = "block"
            content.innerHTML = safe
            buildNav()
          } else {
            // fallback אם יצא ריק אחרי סינון
            pre.style.display = "block"
            pre.textContent = text
          }
        } else {
          pre.style.display = "block"
          pre.textContent = text
        }
      }

      main().catch((e) => {
        const loading = document.getElementById("loading")
        const err = document.getElementById("err")
        loading.style.display = "none"
        err.style.display = "block"
        err.textContent = String(e && e.message ? e.message : e)
      })
    </script>
  </body>
</html>
